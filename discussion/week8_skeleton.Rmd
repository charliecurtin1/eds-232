```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(here) #easy file paths
library(tidyverse) #data wrangling
library(tidymodels) #modeling
library(tidyclust)
library(patchwork)

set.seed(42) #set random seed
```

#### Data Cleaning

Today, we are going to use the top 3 habitats and take a random sample of 500, then select trophic level and length for clustering

```{r}

fish_clean = read_csv(here("discussion", "data", "fish_clean.csv")) %>% 
  mutate(habitat = as.factor(habitat)) %>% 
  filter(habitat %in% c("reef-associated", "demersal", "benthopelagic")) %>% 
  sample_n(500)

fish_clust = fish_clean %>% 
  select(trophic_level_impute, length_impute) 

lapply(fish_clust, class)

```
- We pick 3 habitat types, so ideally our clusters put the observations into the correct habitat type
### Clustering

```{r}
# cross-validation to determine our optimal cluster value
folds <- vfold_cv(fish_clust, v = 5)
```

#### KMeans

```{r}
kmeans_spec <- k_means(num_clusters = tune()) %>% 
  set_engine("stats")
```

```{r}
# don't have something on the left side of the ~ bc we don't have a target variable
recipe <- recipe(~., data = fish_clust) %>% 
  step_normalize(all_predictors())

# set up a workflow
kmean_wf <- workflow(recipe, kmeans_spec)
```

```{r}
# set up a grid of 10 different clusters
clust_num_grid <- grid_regular(num_clusters(),
                               levels = 10)
```

```{r}
res <- tune_cluster(
  kmean_wf,
  resamples = folds,
  grid = clust_num_grid,
  control = control_grid(save_pred = TRUE, extract = identity),
  metrics = cluster_metric_set(sse_within_total, sse_total, sse_ratio)
)
```

```{r}
res_metrics <- res %>% collect_metrics()

res_metrics
```

```{r}
# plotting our results to use the elbow method
res_metrics %>%
  filter(.metric == "sse_ratio") %>%
  ggplot(aes(x = num_clusters, y = mean)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  ylab("mean WSS/TSS ratio, over 5 folds") +
  xlab("Number of clusters") +
  scale_x_continuous(breaks = 1:10)
```

```{r}
## testing with 4 clusters and 3 clusters to see which works better
# 4 clusters
kmeans_spec1 <- k_means(num_clusters = 4) %>% 
  set_engine("stats")

kmeans_wf1 <- workflow(recipe, kmeans_spec1)
```

```{r}
# fitting our data
kmeans_fit1 <- kmeans_wf1 %>% 
  fit(data = fish_clust)

kmeans_fit1
  
```

- we want the between_ss/total_ss ratio to be higher. shows the variance outside the clusters. We want the variance within clusters to be as low as possible

```{r}
# testing with 5 clusters
kmeans_spec2 <- k_means(num_clusters = 5) %>% 
  set_engine("stats")

kmeans_wf2 <- workflow(recipe, kmeans_spec2)
```

```{r}
# fitting our data
kmeans_fit2 <- kmeans_wf2 %>% 
  fit(data = fish_clust)

kmeans_fit2
```

```{r}
# metric for perf
kmeans_fit1 %>% 
  silhouette_avg(fish_clust)
```

```{r}
kmeans_fit2 %>% 
  silhouette_avg(fish_clust)
```
- want a higher silhouette average. Measures how similar things are to their own cluster compared to the separation between clusters. A metric to compare the number of clusters between models

```{r}
## use fit1 because it had the highest silhouette
# extract the components and attach new clusters to the observations
clusters <- kmeans_fit1 %>% 
  extract_cluster_assignment()

fish_clean$cluster <- clusters$.cluster
  
```

```{r}
# plot clustering
ggplot(fish_clean) +
  geom_point(aes(trophic_level_impute, length_impute, color = habitat, shape = cluster)) +
  theme_bw() +
  scale_color_viridis_d()
```

#### Heirarchical Clustering

```{r}
hc_spec <- hier_clust(linkage_method = "average")

```

```{r}
hc_fit <- hc_spec %>% 
  fit(~., data = fish_clean)
```

```{r}
hc_fit$fit %>% plot(hang = -1)
```

